var moment,_;angular.module("angularPlanningApp",["angularViewportWatch","ui.slimscroll"]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{updateEvents:"&",resources:"=",currentDate:"=",lastDate:"=?",cellWidth:"=",maxBodyHeight:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onPersonClick:"&?",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","$cacheFactory","$window","$timeout","moment","_",function(e,n,t,a,o,r,i){function s(){i.map(c.resources,function(e){c.toggleFolding(e,e.open)})}function d(){var n=c.dates.days[0],t=c.dates.days[c.dates.days.length-1];i.isUndefined(n)===!1&&i.isUndefined(t)===!1&&e.updateEvents({minDate:n.day,maxDate:t.day}).then(function(n){e.$broadcast("updateEvents",n)})}var c=this,l=t("planning-date-index-cache");e.$on("$destroy",function(){l.destroy()}),c.toggleFolding=function(e,n){for(var t=i.findIndex(c.resources,{id:e.id}),a=t+1;a<c.resources.length;a++){var o=c.resources[a];if(!(o.tree_id===e.tree_id&&o.level>e.level))break;o.show=n}e.show=i.get(i.find(c.resources,{id:e.parent}),"open",!0),e.open=n},e.$watchCollection("resources",function(n){c.resources=n,s(),d();var t=i.sumBy(c.resources,function(e){return e.members.length});e.bodyHeight=Math.min(e.maxBodyHeight,21*(c.resources.length+t))}),c.getDay=function(e){return l.get(e)?l.get(e):c.dates.current.clone().add(e,"days")},c.isToday=function(e){return c.getDay(e).isSame(r(),"day")},c.isEndOfWeek=function(e){var n=c.getDay(e);return n.clone().endOf("week").isSame(n,"day")},c.isMorningOnly=function(e,n){var t=c.getDay(e);return n.afternoonIncluded===!1&&r(n.endsAt).isSame(t,"day")},c.isAfternoonOnly=function(e,n){var t=c.getDay(e);return n.morningIncluded===!1&&r(n.startsAt).isSame(t,"day")},c.onDayHover=i.debounce(function(n,t){if(e.onDayHover&&!t.group){var a=c.getDay(n).toDate();e.onDayHover({day:a,resource:t})}},250),c.onResourceClick=function(n){e.$apply(function(){c.toggleFolding(n,!n.open)})},c.onPersonClick=function(n){e.onPersonClick&&e.onPersonClick({resource:n})},c.onDayClick=function(n,t){if(e.onDayClick){var a=c.getDay(n).toDate();e.onDayClick({day:a,resource:t})}},c.onEventClick=function(n,t,a,o){if(e.onEventClick){var r=c.getDay(a).toDate();e.onEventClick({event:t,day:r,resource:o})}},c.getEventsDay=function(e,n){var t=c.getDay(e).format("YYYY-MM-DD");return i.get(c.events,[n,t],[])},c.dates={current:null,indices:[],days:[],months:[]},c.nbDaysDisplayed=0,c.planningWidth=0,c.events=[],e.$on("updateEvents",function(n,t){var a=c.dates.days[0],s=c.dates.days[c.dates.days.length-1];e.$broadcast("toggleWatchers",!0),o(function(){e.$broadcast("toggleWatchers",!1)},0),i.isUndefined(a)===!1&&i.isUndefined(s)===!1&&(c.events=[],i.forEach(c.dates.indices,function(e){var n=c.getDay(e),a=n.format("YYYY-MM-DD");i.forEach(t,function(e){n.isSameOrAfter(r(e.startsAt),"day")&&n.isSameOrBefore(r(e.endsAt),"day")&&i.set(c.events,[e.resourceId,a],i.concat(i.get(c.events,[e.resourceId,a],[]),e))})}))}),c.computeNbDaysDisplayed=function(){e.lastDate?c.nbDaysDisplayed=e.lastDate.diff(e.currentDate,"days")+1:c.nbDaysDisplayed=i.floor(e.planningWidth*(1-e.planningResourcesColumnRatio/100)/e.cellWidth)},c.displayDates=function(){l.removeAll(),e.$broadcast("toggleWatchers",!0),o(function(){e.$broadcast("toggleWatchers",!1)},0),c.computeNbDaysDisplayed(),c.dates.current=e.currentDate.clone();for(var n=[],t=[],a={day:null,isToday:!1,isEndOfWeek:!1},r={month:null,nbDaysDisplayed:0},s=c.dates.current.clone(),u=s.clone().startOf("month"),y=0;y<c.nbDaysDisplayed;y++)a={index:y,day:s.toDate(),dayNumber:s.format("DD"),weekDayName:s.format("dd"),isToday:c.isToday(y),isEndOfWeek:c.isEndOfWeek(y)},n.push(a),u.isSame(r.month,"month")===!1?(r={month:u.toDate(),monthName:u.format("MMMM YYYY"),nbDaysDisplayed:1},t.push(r)):r.nbDaysDisplayed++,l.put(y,s.clone()),s.add(1,"days"),u=s.clone().startOf("month");c.dates.days=n,c.dates.months=t,e.resources.length>0&&d(),c.dates.indices=i.range(c.nbDaysDisplayed)},e.$watch("planningWidth",function(e,n){e!==n&&(c.dates.indices=[],c.displayDates())}),e.$watch(function(){return e.currentDate.unix()},function(e,n){e!==n&&c.displayDates()}),e.$on("updatePlanning",function(){d()})}]}}),angular.module("angularPlanningApp").directive("highlightHoveredDay",function(){function e(e){return angular.element(document.querySelector(e))}return function(n,t,a){t.on("mouseenter",function(){e("#day-number-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell"),e("#day-weekdayname-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell")}),t.on("mouseleave",function(){e("#day-number-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell"),e("#day-weekdayname-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell")})}}),angular.module("angularPlanningApp").directive("onClick",function(){return function(e,n,t){n.on("click",function(n){e.$eval(t.onClick),n.stopPropagation()})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(e,n,t){n.on("mouseenter",function(){e.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(e,n){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,n.onresize=e.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]);