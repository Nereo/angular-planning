var moment,_;angular.module("angularPlanningApp",["angularViewportWatch","ui.slimscroll"]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{updateEvents:"&",resources:"=",currentDate:"=",lastDate:"=?",cellWidth:"=",maxBodyHeight:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onPersonClick:"&?",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","$cacheFactory","$window","$timeout","moment","_",function(e,n,a,t,o,i,r){function s(){r.map(l.resources,function(e){e.show=!0,l.toggleFolding(e,e.open)})}function d(){var n=l.dates.days[0],a=l.dates.days[l.dates.days.length-1];r.isUndefined(n)===!1&&r.isUndefined(a)===!1&&e.updateEvents({minDate:n.day,maxDate:a.day}).then(function(n){e.$broadcast("updateEvents",n)})}var l=this,c=a("planning-date-index-cache");e.$on("$destroy",function(){c.destroy()}),l.toggleFolding=function(e,n){for(var a=r.findIndex(l.resources,{id:e.id}),t=a+1;t<l.resources.length;t++){var o=l.resources[t];if(!(o.tree_id===e.tree_id&&o.level>e.level))break;o.show=n}e.open=n},e.$watchCollection("resources",function(n){l.resources=n,s(),d(),e.bodyHeight=Math.min(e.maxBodyHeight,20*l.resources.length)}),l.getDay=function(e){return c.get(e)?c.get(e):l.dates.current.clone().add(e,"days")},l.isToday=function(e){return l.getDay(e).isSame(i(),"day")},l.isEndOfWeek=function(e){var n=l.getDay(e);return n.clone().endOf("week").isSame(n,"day")},l.isMorningOnly=function(e,n){var a=l.getDay(e);return n.afternoonIncluded===!1&&i(n.endsAt).isSame(a,"day")},l.isAfternoonOnly=function(e,n){var a=l.getDay(e);return n.morningIncluded===!1&&i(n.startsAt).isSame(a,"day")},l.onDayHover=r.debounce(function(n,a){if(e.onDayHover&&!a.group){var t=l.getDay(n).toDate();e.onDayHover({day:t,resource:a})}},250),l.onResourceClick=function(n){e.$apply(function(){l.toggleFolding(n,!n.open)})},l.onPersonClick=function(n){e.onPersonClick&&e.onPersonClick({resource:n})},l.onDayClick=function(n,a){if(e.onDayClick){var t=l.getDay(n).toDate();e.onDayClick({day:t,resource:a})}},l.onEventClick=function(n,a,t,o){if(e.onEventClick){var i=l.getDay(t).toDate();e.onEventClick({event:a,day:i,resource:o})}},l.getEventsDay=function(e,n){var a=l.getDay(e).format("YYYY-MM-DD");return r.get(l.events,[n,a],[])},l.dates={current:null,indices:[],days:[],months:[]},l.nbDaysDisplayed=0,l.planningWidth=0,l.events=[],e.$on("updateEvents",function(e,n){var a=l.dates.days[0],t=l.dates.days[l.dates.days.length-1];r.isUndefined(a)===!1&&r.isUndefined(t)===!1&&(l.events=[],r.forEach(l.dates.indices,function(e){var a=l.getDay(e),t=a.format("YYYY-MM-DD");r.forEach(n,function(e){a.isSameOrAfter(i(e.startsAt),"day")&&a.isSameOrBefore(i(e.endsAt),"day")&&r.set(l.events,[e.resourceId,t],r.concat(r.get(l.events,[e.resourceId,t],[]),e))})}))}),l.computeNbDaysDisplayed=function(){e.lastDate?l.nbDaysDisplayed=e.lastDate.diff(e.currentDate,"days")+1:l.nbDaysDisplayed=r.floor(e.planningWidth*(1-e.planningResourcesColumnRatio/100)/e.cellWidth)},l.displayDates=function(){c.removeAll(),l.computeNbDaysDisplayed(),l.dates.current=e.currentDate.clone();for(var n=[],a=[],t={day:null,isToday:!1,isEndOfWeek:!1},o={month:null,nbDaysDisplayed:0},i=l.dates.current.clone(),s=i.clone().startOf("month"),u=0;u<l.nbDaysDisplayed;u++)t={index:u,day:i.toDate(),dayNumber:i.format("DD"),weekDayName:i.format("dd"),isToday:l.isToday(u),isEndOfWeek:l.isEndOfWeek(u)},n.push(t),s.isSame(o.month,"month")===!1?(o={month:s.toDate(),monthName:s.format("MMMM YYYY"),nbDaysDisplayed:1},a.push(o)):o.nbDaysDisplayed++,c.put(u,i.clone()),i.add(1,"days"),s=i.clone().startOf("month");l.dates.days=n,l.dates.months=a,e.resources.length>0&&d(),l.dates.indices=r.range(l.nbDaysDisplayed)},e.$watch("planningWidth",function(e,n){e!==n&&(l.dates.indices=[],l.displayDates())}),e.$watch(function(){return e.currentDate.unix()},function(e,n){e!==n&&l.displayDates()}),e.$on("updatePlanning",function(){d()})}]}}),angular.module("angularPlanningApp").directive("highlightHoveredDay",function(){function e(e){return angular.element(document.querySelector(e))}return function(n,a,t){a.on("mouseenter",function(){e("#day-number-"+t.highlightHoveredDay).addClass("planning-day-hovered-cell"),e("#day-weekdayname-"+t.highlightHoveredDay).addClass("planning-day-hovered-cell")}),a.on("mouseleave",function(){e("#day-number-"+t.highlightHoveredDay).removeClass("planning-day-hovered-cell"),e("#day-weekdayname-"+t.highlightHoveredDay).removeClass("planning-day-hovered-cell")})}}),angular.module("angularPlanningApp").directive("onClick",function(){return function(e,n,a){n.on("click",function(n){e.$eval(a.onClick),n.stopPropagation()})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(e,n,a){n.on("mouseenter",function(){e.$eval(a.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(e,n){return{restrict:"A",scope:{watchedWidth:"="},link:function(a,t){a.watchedWidth=t[0].offsetWidth,n.onresize=e.debounce(function(){a.$apply(function(){a.watchedWidth=t[0].offsetWidth})},100)}}}]);