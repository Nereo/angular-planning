var moment,_;angular.module("angularPlanningApp",[]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{getEvents:"&",resources:"=",currentDate:"=",cellWidth:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","moment","_",function(n,e,t,a){function r(n,e){for(var t=0;t<d.flattenedResources.length;t++){var a=d.flattenedResources[t];a.parentGroup===n.id&&(a.show=e,a.group===!0&&a.open===!0&&r(a,e))}}function o(){for(var n=0;n<d.flattenedResources.length;n++)d.flattenedResources[n].group===!0&&(null===d.flattenedResources[n].parentGroup&&(d.flattenedResources[n].show=!0),d.toggleFolding(d.flattenedResources[n],d.flattenedResources[n].open))}function i(n){var e=function(n,t,r){return a.flatMap(n,function(n){return n.parentGroup=t,n.depth=r,n.children?(n.group=!0,a.concat(n,e(n.children,n.id,r+1))):(n.group=!1,[n])})};return e(n,null,0)}function s(n){for(var e=[],a={month:null,nbDaysDisplayed:0},r=0;r<n.length;r++){var o=t(n[r].day).startOf("month");o.isSame(a.month,"month")===!1?(a={month:o.toDate(),monthName:o.format("MMMM YYYY"),nbDaysDisplayed:1},e.push(a)):a.nbDaysDisplayed++}return e}function u(){var e=d.dates.days[0],t=d.dates.days[d.dates.days.length-1];if(a.isUndefined(e)===!1&&a.isUndefined(t)===!1){var r=n.getEvents({minDate:e.day,maxDate:t.day});r.then(function(n){d.events=n})}}var d=this;d.toggleFolding=function(n,e){n.group===!0&&(r(n,e),n.open=e)},d.flattenedResources=[],n.$watchCollection("resources",function(n){d.flattenedResources=i(n),o(),u()}),d.getDay=function(n){return d.dates.current.clone().add(n,"days")},d.isToday=function(n){return d.getDay(n).isSame(t(),"day")},d.isEndOfWeek=function(n){var e=d.getDay(n);return e.clone().endOf("week").isSame(e,"day")},d.isMorningOnly=function(n,e){var a=d.getDay(n);return e.afternoonIncluded===!1&&t(e.endsAt).isSame(a,"day")},d.isAfternoonOnly=function(n,e){var a=d.getDay(n);return e.morningIncluded===!1&&t(e.startsAt).isSame(a,"day")},d.onDayHover=a.debounce(function(e,t){if(n.onDayHover&&!t.group){var a=d.getDay(e).toDate();n.onDayHover({day:a,resource:t})}},250),d.onDayClick=function(e,t){if(n.onDayClick&&!t.group){var a=d.getDay(e).toDate();n.onDayClick({day:a,resource:t})}},d.onEventClick=function(e,t,a,r){if(n.onEventClick&&!r.group){var o=d.getDay(a).toDate();n.onEventClick({event:t,day:o,resource:r})}e.stopPropagation()},d.getEventsDay=function(n,e){var r=d.getDay(n);return a.filter(d.events[e],function(n){return r.isSameOrAfter(t(n.startsAt),"day")&&r.isSameOrBefore(t(n.endsAt),"day")})},d.dates={current:null,dayHovered:-1,indices:[],days:[],months:[]},d.nbDaysDisplayed=0,d.planningWidth=0,d.events=[],d.displayDates=function(){d.dates.current=n.currentDate.clone();for(var e=[],t={day:null,isToday:!1,isEndOfWeek:!1},r=d.dates.current.clone(),o=0;o<d.nbDaysDisplayed;o++)t={index:o,day:r.toDate(),dayNumber:r.format("DD"),weekDayName:r.format("dd"),isToday:d.isToday(o),isEndOfWeek:d.isEndOfWeek(o)},e.push(t),r.add(1,"days");d.dates.days=e,n.resources.length>0&&u(),d.dates.indices=a.range(d.nbDaysDisplayed),d.dates.months=s(d.dates.days)},d.highlightDayHovered=function(n){d.dates.dayHovered=n},n.$watch("planningWidth",function(e,t){e!==t&&(d.nbDaysDisplayed=a.floor(e*(1-n.planningResourcesColumnRatio/100)/n.cellWidth),d.dates.indices=[],d.displayDates())}),n.$watch(function(){return n.currentDate.unix()},function(n,e){n!==e&&d.displayDates()})}]}}),angular.module("angularPlanningApp").directive("angularPlanningResourceRow",function(){return{require:"^^angularPlanning",restrict:"A",scope:{resource:"=",events:"=",dates:"="},link:function(n,e,t,a){n.planningController=a},templateUrl:"angular-planning/views/angular-planning-resource-row.html"}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(n,e){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,e.onresize=n.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]);