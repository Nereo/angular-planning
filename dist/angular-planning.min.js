var moment,_;angular.module("angularPlanningApp",[]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{getEvents:"&",resources:"=",currentDate:"=",cellWidth:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","moment","_",function(e,n,t,a){function o(e,n){for(var t=0;t<u.flattenedResources.length;t++){var a=u.flattenedResources[t];a.parentGroup===e.id&&(a.show=n,a.group===!0&&a.open===!0&&o(a,n))}}function r(){for(var e=0;e<u.flattenedResources.length;e++)u.flattenedResources[e].group===!0&&(null===u.flattenedResources[e].parentGroup&&(u.flattenedResources[e].show=!0),u.toggleFolding(u.flattenedResources[e],u.flattenedResources[e].open))}function s(e){var n=function(e,t,o){return a.flatMap(e,function(e){return e.parentGroup=t,e.depth=o,e.children?(e.group=!0,a.concat(e,n(e.children,e.id,o+1))):(e.group=!1,[e])})};return n(e,null,0)}function i(e){for(var n=[],a={month:null,nbDaysDisplayed:0},o=0;o<e.length;o++){var r=t(e[o].day).startOf("month");r.isSame(a.month,"month")===!1?(a={month:r.toDate(),monthName:r.format("MMMM YYYY"),nbDaysDisplayed:1},n.push(a)):a.nbDaysDisplayed++}return n}function d(){var n=u.dates.days[0],t=u.dates.days[u.dates.days.length-1];if(a.isUndefined(n)===!1&&a.isUndefined(t)===!1){u.events=[];var o=e.getEvents({minDate:n.day,maxDate:t.day});o.then(function(e){a.forEach(u.dates.indices,function(n){var t=u.getDay(n);a.forEach(a.filter(u.flattenedResources,{group:!1}),function(o){var r=u.getEventsDay(t,e[o.id]);a.set(u.events,[o.id,n],r)})})})}}var u=this;u.toggleFolding=function(e,n){e.group===!0&&(o(e,n),e.open=n)},u.flattenedResources=[],e.$watchCollection("resources",function(e){u.flattenedResources=s(e),r(),d()}),u.getDay=function(e){return u.dates.current.clone().add(e,"days")},u.isToday=function(e){return u.getDay(e).isSame(t(),"day")},u.isEndOfWeek=function(e){var n=u.getDay(e);return n.clone().endOf("week").isSame(n,"day")},u.isMorningOnly=function(e,n){var a=u.getDay(e);return n.afternoonIncluded===!1&&t(n.endsAt).isSame(a,"day")},u.isAfternoonOnly=function(e,n){var a=u.getDay(e);return n.morningIncluded===!1&&t(n.startsAt).isSame(a,"day")},u.onDayHover=a.debounce(function(n,t){if(e.onDayHover&&!t.group){var a=u.getDay(n).toDate();e.onDayHover({day:a,resource:t})}},250),u.onDayClick=function(n,t){if(e.onDayClick&&!t.group){var a=u.getDay(n).toDate();e.onDayClick({day:a,resource:t})}},u.onEventClick=function(n,t,a,o){if(e.onEventClick&&!o.group){var r=u.getDay(a).toDate();e.onEventClick({event:t,day:r,resource:o})}n.stopPropagation()},u.getEventsDay=function(e,n){return a.filter(n,function(n){return e.isSameOrAfter(t(n.startsAt),"day")&&e.isSameOrBefore(t(n.endsAt),"day")})},u.dates={current:null,dayHovered:-1,indices:[],days:[],months:[]},u.nbDaysDisplayed=0,u.planningWidth=0,u.events=[],u.displayDates=function(){u.dates.current=e.currentDate.clone();for(var n=[],t={day:null,isToday:!1,isEndOfWeek:!1},o=u.dates.current.clone(),r=0;r<u.nbDaysDisplayed;r++)t={index:r,day:o.toDate(),dayNumber:o.format("DD"),weekDayName:o.format("dd"),isToday:u.isToday(r),isEndOfWeek:u.isEndOfWeek(r)},n.push(t),o.add(1,"days");u.dates.days=n,e.resources.length>0&&d(),u.dates.indices=a.range(u.nbDaysDisplayed),u.dates.months=i(u.dates.days)},u.highlightDayHovered=function(e){u.dates.dayHovered=e},e.$watch("planningWidth",function(n,t){n!==t&&(u.nbDaysDisplayed=a.floor(n*(1-e.planningResourcesColumnRatio/100)/e.cellWidth),u.dates.indices=[],u.displayDates())}),e.$watch(function(){return e.currentDate.unix()},function(e,n){e!==n&&u.displayDates()})}]}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(e,n){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,n.onresize=e.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]);