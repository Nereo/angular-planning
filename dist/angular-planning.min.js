var moment,_;angular.module("angularPlanningApp",[]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{getEvents:"&",getEventsResource:"&?",resources:"=",currentDate:"=",lastDate:"=?",cellWidth:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","$cacheFactory","$window","moment","_",function(e,n,t,a,o,r){function i(e,n){for(var t=0;t<c.flattenedResources.length;t++){var a=c.flattenedResources[t];a.parentGroup===e.id&&(a.show=n,a.group===!0&&a.open===!0&&i(a,n))}}function s(e){for(var n=0;n<c.flattenedResources.length;n++)c.flattenedResources[n].group===!0&&(null===c.flattenedResources[n].parentGroup&&(c.flattenedResources[n].show=!0),c.toggleFolding(c.flattenedResources[n],e?e:c.flattenedResources[n].open))}function d(e){var n=function(e,t,a){return r.flatMap(e,function(e){return e.parentGroup=t,e.depth=a,e.children?(e.group=!0,r.concat(e,n(e.children,e.id,a+1))):(e.group=!1,[e])})};return n(e,null,0)}function u(){var n=c.dates.days[0],t=c.dates.days[c.dates.days.length-1];if(r.isUndefined(n)===!1&&r.isUndefined(t)===!1){var a=e.getEvents({minDate:n.day,maxDate:t.day});a.then(function(e){c.events=[],r.forEach(c.dates.indices,function(n){var t=c.getDay(n),a=t.format("YYYY-MM-DD");r.forEach(e,function(e,n){var i=[];r.forEach(e,function(e){t.isSameOrAfter(o(e.startsAt),"day")&&t.isSameOrBefore(o(e.endsAt),"day")&&i.push(e)}),i.length>0&&r.set(c.events,[n,a],i)})})})}}function l(n){var t=c.dates.days[0],a=c.dates.days[c.dates.days.length-1];if(r.isUndefined(t)===!1&&r.isUndefined(a)===!1){var i=e.getEventsResource({minDate:t.day,maxDate:a.day,resourceId:n});i.then(function(e){r.set(c.events,n,[]),r.forEach(c.dates.indices,function(t){var a=c.getDay(t),i=a.format("YYYY-MM-DD"),s=[];r.forEach(e,function(e){a.isSameOrAfter(o(e.startsAt),"day")&&a.isSameOrBefore(o(e.endsAt),"day")&&s.push(e)}),s.length>0&&r.set(c.events,[n,i],s)})})}}var c=this,f=t("planning-date-index-cache");e.$on("$destroy",function(){f.destroy()}),c.toggleFolding=function(e,n){e.group===!0&&(i(e,n),e.open=n)},c.flattenedResources=[],e.$watchCollection("resources",function(e){c.flattenedResources=d(e),s(),u()}),c.getDay=function(e){return f.get(e)?f.get(e):c.dates.current.clone().add(e,"days")},c.isToday=function(e){return c.getDay(e).isSame(o(),"day")},c.isEndOfWeek=function(e){var n=c.getDay(e);return n.clone().endOf("week").isSame(n,"day")},c.isMorningOnly=function(e,n){var t=c.getDay(e);return n.afternoonIncluded===!1&&o(n.endsAt).isSame(t,"day")},c.isAfternoonOnly=function(e,n){var t=c.getDay(e);return n.morningIncluded===!1&&o(n.startsAt).isSame(t,"day")},c.onDayHover=r.debounce(function(n,t){if(e.onDayHover&&!t.group){var a=c.getDay(n).toDate();e.onDayHover({day:a,resource:t})}},250),c.onDayClick=function(n,t){if(e.onDayClick&&!t.group){var a=c.getDay(n).toDate();e.onDayClick({day:a,resource:t})}},c.onEventClick=function(n,t,a,o){if(e.onEventClick&&!o.group){var r=c.getDay(a).toDate();e.onEventClick({event:t,day:r,resource:o})}},c.getEventsDay=function(e,n){var t=c.getDay(e).format("YYYY-MM-DD");return r.get(c.events,[n,t],[])},c.dates={current:null,indices:[],days:[],months:[]},c.nbDaysDisplayed=0,c.planningWidth=0,c.events=[],c.computeNbDaysDisplayed=function(){e.lastDate?c.nbDaysDisplayed=e.lastDate.diff(e.currentDate,"days")+1:c.nbDaysDisplayed=r.floor(e.planningWidth*(1-e.planningResourcesColumnRatio/100)/e.cellWidth)},c.displayDates=function(){f.removeAll(),c.computeNbDaysDisplayed(),c.dates.current=e.currentDate.clone();for(var n=[],t=[],a={day:null,isToday:!1,isEndOfWeek:!1},o={month:null,nbDaysDisplayed:0},i=c.dates.current.clone(),s=i.clone().startOf("month"),d=0;d<c.nbDaysDisplayed;d++)a={index:d,day:i.toDate(),dayNumber:i.format("DD"),weekDayName:i.format("dd"),isToday:c.isToday(d),isEndOfWeek:c.isEndOfWeek(d)},n.push(a),s.isSame(o.month,"month")===!1?(o={month:s.toDate(),monthName:s.format("MMMM YYYY"),nbDaysDisplayed:1},t.push(o)):o.nbDaysDisplayed++,f.put(d,i.clone()),i.add(1,"days"),s=i.clone().startOf("month");c.dates.days=n,c.dates.months=t,e.resources.length>0&&u(),c.dates.indices=r.range(c.nbDaysDisplayed)},e.$watch("planningWidth",function(e,n){e!==n&&(c.dates.indices=[],c.displayDates())}),e.$watch(function(){return e.currentDate.unix()},function(e,n){e!==n&&c.displayDates()}),e.$on("updatePlanningResource",function(n,t){e.getEventsResource&&l(t)})}]}}),angular.module("angularPlanningApp").directive("highlightHoveredDay",function(){function e(e){return angular.element(document.querySelector(e))}return function(n,t,a){t.on("mouseenter",function(){e("#day-number-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell"),e("#day-weekdayname-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell")}),t.on("mouseleave",function(){e("#day-number-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell"),e("#day-weekdayname-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell")})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(e,n,t){n.on("mouseenter",function(){e.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("onClick",function(){return function(e,n,t){n.on("click",function(n){e.$eval(t.onClick),n.stopPropagation()})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(e,n,t){n.on("mouseenter",function(){e.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(e,n){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,n.onresize=e.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]);