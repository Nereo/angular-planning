var moment,_;angular.module("angularPlanningApp",[]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{events:"=",updateEvents:"&",resources:"=",currentDate:"=",lastDate:"=?",cellWidth:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","$cacheFactory","$window","$timeout","moment","_",function(n,e,t,a,o,r,i){function s(n,e){for(var t=0;t<d.flattenedResources.length;t++){var a=d.flattenedResources[t];a.parentGroup===n.id&&(a.show=e,a.group===!0&&a.open===!0&&s(a,e))}}function u(n){for(var e=0;e<d.flattenedResources.length;e++)d.flattenedResources[e].group===!0&&(null===d.flattenedResources[e].parentGroup&&(d.flattenedResources[e].show=!0),d.toggleFolding(d.flattenedResources[e],n?n:d.flattenedResources[e].open))}function c(n){var e=function(n,t,a){return i.flatMap(n,function(n){return n.parentGroup=t,n.depth=a,n.children?(n.group=!0,i.concat(n,e(n.children,n.id,a+1))):(n.group=!1,[n])})};return e(n,null,0)}function l(){var e=d.dates.days[0],t=d.dates.days[d.dates.days.length-1];i.isUndefined(e)===!1&&i.isUndefined(t)===!1&&n.updateEvents({minDate:e.day,maxDate:t.day})}var d=this,f=t("planning-date-index-cache");n.$on("$destroy",function(){f.destroy()}),d.toggleFolding=function(n,e){n.group===!0&&(s(n,e),n.open=e)},d.flattenedResources=[],n.$watchCollection("resources",function(n){d.flattenedResources=c(n),u(),l()}),d.getDay=function(n){return f.get(n)?f.get(n):d.dates.current.clone().add(n,"days")},d.isToday=function(n){return d.getDay(n).isSame(r(),"day")},d.isEndOfWeek=function(n){var e=d.getDay(n);return e.clone().endOf("week").isSame(e,"day")},d.isMorningOnly=function(n,e){var t=d.getDay(n);return e.afternoonIncluded===!1&&r(e.endsAt).isSame(t,"day")},d.isAfternoonOnly=function(n,e){var t=d.getDay(n);return e.morningIncluded===!1&&r(e.startsAt).isSame(t,"day")},d.onDayHover=i.debounce(function(e,t){if(n.onDayHover&&!t.group){var a=d.getDay(e).toDate();n.onDayHover({day:a,resource:t})}},250),d.onDayClick=function(e,t){if(n.onDayClick&&!t.group){var a=d.getDay(e).toDate();n.onDayClick({day:a,resource:t})}},d.onEventClick=function(e,t,a,o){if(n.onEventClick&&!o.group){var r=d.getDay(a).toDate();n.onEventClick({event:t,day:r,resource:o})}},d.getEventsDay=function(n,e){var t=d.getDay(n).format("YYYY-MM-DD");return i.get(d.events,[e,t],[])},d.dates={current:null,indices:[],days:[],months:[]},d.nbDaysDisplayed=0,d.planningWidth=0,d.events=[],n.$watchCollection("events",function(n){var e=d.dates.days[0],t=d.dates.days[d.dates.days.length-1];i.isUndefined(e)===!1&&i.isUndefined(t)===!1&&(d.events=[],i.forEach(d.dates.indices,function(e){var t=d.getDay(e),a=t.format("YYYY-MM-DD");i.forEach(n,function(n){t.isSameOrAfter(r(n.startsAt),"day")&&t.isSameOrBefore(r(n.endsAt),"day")&&i.set(d.events,[n.resourceId,a],i.concat(i.get(d.events,[n.resourceId,a],[]),n))})}))}),d.computeNbDaysDisplayed=function(){n.lastDate?d.nbDaysDisplayed=n.lastDate.diff(n.currentDate,"days")+1:d.nbDaysDisplayed=i.floor(n.planningWidth*(1-n.planningResourcesColumnRatio/100)/n.cellWidth)},d.displayDates=function(){n.$broadcast("resume"),o(function(){n.$broadcast("suspend")},0,!1),f.removeAll(),d.computeNbDaysDisplayed(),d.dates.current=n.currentDate.clone();for(var e=[],t=[],a={day:null,isToday:!1,isEndOfWeek:!1},r={month:null,nbDaysDisplayed:0},s=d.dates.current.clone(),u=s.clone().startOf("month"),c=0;c<d.nbDaysDisplayed;c++)a={index:c,day:s.toDate(),dayNumber:s.format("DD"),weekDayName:s.format("dd"),isToday:d.isToday(c),isEndOfWeek:d.isEndOfWeek(c)},e.push(a),u.isSame(r.month,"month")===!1?(r={month:u.toDate(),monthName:u.format("MMMM YYYY"),nbDaysDisplayed:1},t.push(r)):r.nbDaysDisplayed++,f.put(c,s.clone()),s.add(1,"days"),u=s.clone().startOf("month");d.dates.days=e,d.dates.months=t,n.resources.length>0&&l(),d.dates.indices=i.range(d.nbDaysDisplayed)},n.$watch("planningWidth",function(n,e){n!==e&&(d.dates.indices=[],d.displayDates())}),n.$watch(function(){return n.currentDate.unix()},function(n,e){n!==e&&d.displayDates()})}]}}),angular.module("angularPlanningApp").directive("highlightHoveredDay",function(){function n(n){return angular.element(document.querySelector(n))}return function(e,t,a){t.on("mouseenter",function(){n("#day-number-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell"),n("#day-weekdayname-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell")}),t.on("mouseleave",function(){n("#day-number-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell"),n("#day-weekdayname-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell")})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(n,e,t){e.on("mouseenter",function(){n.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("onClick",function(){return function(n,e,t){e.on("click",function(e){n.$eval(t.onClick),e.stopPropagation()})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(n,e,t){e.on("mouseenter",function(){n.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("oneTimeRefresh",["$compile","$interpolate",function(n,e){function t(n,e){angular.forEach(n,function(n,t){"$"!==t[0]&&(e[t]=n)})}function a(n){angular.forEach(n.children(),function(n){o(angular.element(n))})}function o(n){n.data().hasOwnProperty("$scope")&&(n.data().$scope.$$watchers=[]),a(n)}return{scope:!1,compile:function(o){var r,i;return r=o.html(),i=e(r),function(e,o,r){var s=r.id,u=o;u.closest("tbody").on("refresh-item-"+s,function(){a(u);var o=e.$parent.$new();t(e,o);var r=n(i(o))(o);u.html(r)})}},restrict:"A"}}]),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(n,e){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,e.onresize=n.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]),angular.module("angularPlanningApp").directive("suspendable-watch",function(){return{link:function(n){var e;n.$on("suspend",function(){e=n.$$watchers,n.$$watchers=[]}),n.$on("resume",function(){e&&(n.$$watchers=e),e=void 0})}}}),angular.module("angularPlanningApp").directive("suspendableWatch",function(){return{link:function(n){var e;n.$on("suspend",function(){console.log("suspend watch"),e=n.$$watchers,n.$$watchers=[]}),n.$on("resume",function(){console.log("resume watch"),e&&(n.$$watchers=e),e=void 0})}}});