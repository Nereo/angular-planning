var moment,_;angular.module("angularPlanningApp",[]).constant("moment",moment).constant("_",_),angular.module("angularPlanningApp").directive("angularPlanning",function(){return{restrict:"E",scope:{getEvents:"&",resources:"=",currentDate:"=",cellWidth:"=",planningResourcesColumnRatio:"=",showDayOfWeek:"=",onDayHover:"&?",onDayClick:"&?",onEventClick:"&?"},templateUrl:"angular-planning/views/angular-planning.html",controllerAs:"vm",controller:["$scope","$q","$cacheFactory","moment","_",function(n,e,t,a,o){function r(n,e){for(var t=0;t<s.flattenedResources.length;t++){var a=s.flattenedResources[t];a.parentGroup===n.id&&(a.show=e,a.group===!0&&a.open===!0&&r(a,e))}}function i(){for(var n=0;n<s.flattenedResources.length;n++)s.flattenedResources[n].group===!0&&(null===s.flattenedResources[n].parentGroup&&(s.flattenedResources[n].show=!0),s.toggleFolding(s.flattenedResources[n],s.flattenedResources[n].open))}function u(n){var e=function(n,t,a){return o.flatMap(n,function(n){return n.parentGroup=t,n.depth=a,n.children?(n.group=!0,o.concat(n,e(n.children,n.id,a+1))):(n.group=!1,[n])})};return e(n,null,0)}function l(){var e=s.dates.days[0],t=s.dates.days[s.dates.days.length-1];if(o.isUndefined(e)===!1&&o.isUndefined(t)===!1){var r=n.getEvents({minDate:e.day,maxDate:t.day});r.then(function(n){s.events=[],o.forEach(s.dates.indices,function(e){var t=s.getDay(e),r=t.format("YYYY-MM-DD");o.forEach(n,function(n,e){var i=[];o.forEach(n,function(n){t.isSameOrAfter(a(n.startsAt),"day")&&t.isSameOrBefore(a(n.endsAt),"day")&&i.push(n)}),i.length>0&&o.set(s.events,[e,r],i)})})})}}var s=this,d=t("planning-date-index-cache");s.toggleFolding=function(n,e){n.group===!0&&(r(n,e),n.open=e)},s.flattenedResources=[],n.$watchCollection("resources",function(n){s.flattenedResources=u(n),i(),l()}),s.getDay=function(n){return d.get(n)?d.get(n):s.dates.current.clone().add(n,"days")},s.isToday=function(n){return s.getDay(n).isSame(a(),"day")},s.isEndOfWeek=function(n){var e=s.getDay(n);return e.clone().endOf("week").isSame(e,"day")},s.isMorningOnly=function(n,e){var t=s.getDay(n);return e.afternoonIncluded===!1&&a(e.endsAt).isSame(t,"day")},s.isAfternoonOnly=function(n,e){var t=s.getDay(n);return e.morningIncluded===!1&&a(e.startsAt).isSame(t,"day")},s.onDayHover=o.debounce(function(e,t){if(n.onDayHover&&!t.group){var a=s.getDay(e).toDate();n.onDayHover({day:a,resource:t})}},250),s.onDayClick=function(e,t){if(n.onDayClick&&!t.group){var a=s.getDay(e).toDate();n.onDayClick({day:a,resource:t})}},s.onEventClick=function(e,t,a,o){if(n.onEventClick&&!o.group){var r=s.getDay(a).toDate();n.onEventClick({event:t,day:r,resource:o})}},s.getEventsDay=function(n,e){var t=s.getDay(n).format("YYYY-MM-DD");return o.get(s.events,[e,t],[])},s.dates={current:null,indices:[],days:[],months:[]},s.nbDaysDisplayed=0,s.planningWidth=0,s.events=[],s.displayDates=function(){d.removeAll(),s.dates.current=n.currentDate.clone();for(var e=[],t=[],a={day:null,isToday:!1,isEndOfWeek:!1},r={month:null,nbDaysDisplayed:0},i=s.dates.current.clone(),u=i.clone().startOf("month"),c=0;c<s.nbDaysDisplayed;c++)a={index:c,day:i.toDate(),dayNumber:i.format("DD"),weekDayName:i.format("dd"),isToday:s.isToday(c),isEndOfWeek:s.isEndOfWeek(c)},e.push(a),u.isSame(r.month,"month")===!1?(r={month:u.toDate(),monthName:u.format("MMMM YYYY"),nbDaysDisplayed:1},t.push(r)):r.nbDaysDisplayed++,d.put(c,i.clone()),i.add(1,"days"),u=i.clone().startOf("month");s.dates.days=e,s.dates.months=t,n.resources.length>0&&l(),s.dates.indices=o.range(s.nbDaysDisplayed)},n.$watch("planningWidth",function(e,t){e!==t&&(s.nbDaysDisplayed=o.floor(e*(1-n.planningResourcesColumnRatio/100)/n.cellWidth),s.dates.indices=[],s.displayDates())}),n.$watch(function(){return n.currentDate.unix()},function(n,e){n!==e&&s.displayDates()})}]}}),angular.module("angularPlanningApp").directive("highlightHoveredDay",function(){function n(n){return angular.element(document.querySelector(n))}return function(e,t,a){t.on("mouseenter",function(){n("#day-number-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell"),n("#day-weekdayname-"+a.highlightHoveredDay).addClass("planning-day-hovered-cell")}),t.on("mouseleave",function(){n("#day-number-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell"),n("#day-weekdayname-"+a.highlightHoveredDay).removeClass("planning-day-hovered-cell")})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(n,e,t){e.on("mouseenter",function(){n.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("onClick",function(){return function(n,e,t){e.on("click",function(e){n.$eval(t.onClick),e.stopPropagation()})}}),angular.module("angularPlanningApp").directive("onMouseEnter",function(){return function(n,e,t){e.on("mouseenter",function(){n.$eval(t.onMouseEnter)})}}),angular.module("angularPlanningApp").directive("resizeDetect",["_","$window",function(n,e){return{restrict:"A",scope:{watchedWidth:"="},link:function(t,a){t.watchedWidth=a[0].offsetWidth,e.onresize=n.debounce(function(){t.$apply(function(){t.watchedWidth=a[0].offsetWidth})},100)}}}]);